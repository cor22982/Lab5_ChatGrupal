<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <script type="application/javascript">






        //colocamos un link 
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css';

        // Agrega el elemento link al head del documento
        document.head.appendChild(link);

        // Luego de cargar FontAwesome, puedes utilizar iconos en cualquier parte de tu página
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-paper-plane'; // Clase del icono FontAwesome
        
        //colocamos el modo oscuro o claro
        const lightnight = document.createElement('button');
        lightnight.style.borderRadius = '150px';
        lightnight.style.fontSize = '40px';
        lightnight.style.backgroundColor = 'white';
        lightnight.style.border = 'none'; 
        document.body.appendChild(lightnight);
        const icon2 = document.createElement('i');        
        icon2.className = 'fa-solid fa-circle-half-stroke'
        lightnight.appendChild(icon2);

        

        

        //Vamos a colocar las constantes

        const contenedor = document.createElement('div');

        contenedor.setAttribute('class', 'contenedor');
        contenedor.style.width = '750px'; // Ajusta el ancho según tus necesidades
        contenedor.style.height = '400px'; // Ajusta la altura según tus necesidades
        contenedor.style.backgroundColor = '#ffffff'; // Solo para visualización
        contenedor.style.position = 'fixed';
        contenedor.style.top = '50%';
        contenedor.style.left = '50%';
        contenedor.style.transform = 'translate(-50%, -50%)';
        contenedor.style.borderColor = 'black'
        contenedor.style.borderRadius = '1.5%'
        contenedor.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.5)';
        
      // Agrega el contenedor al body del documento
        document.body.appendChild(contenedor);

        //Creamos los elementos
        const ulContenedor = document.createElement('div'); // Contenedor para ul
        ulContenedor.style.overflowY = 'auto'; // Agregar scroll vertical si es necesario
        ulContenedor.style.maxHeight = '400px'; // Establecer una altura máxima para el contenedor
        contenedor.appendChild(ulContenedor); // Agregar contenedor de ul al contenedor principal
        


        const ul = document.createElement('ul');
        ulContenedor.appendChild(ul); // Agregar ul al contenedor de ul

        const textareaContainer = document.createElement('div');
        textareaContainer.style.maxHeight = '400px';
        textareaContainer.setAttribute('class', 'textAreacontainer');
        textareaContainer.style.display = 'flex'; // Definir como contenedor flex
        textareaContainer.style.marginTop = '10px'
        contenedor.appendChild(textareaContainer);
        

        //elementos de enviar mensajes
        const text = document.createElement('textarea'); //el text area
        text.setAttribute('id', 'text');
        text.setAttribute('rows', '2');
        text.setAttribute('cols', '85');
        text.style.borderRadius = '11px';
        textareaContainer.appendChild(text); // Agregar text al contenedor principal



        const button = document.createElement('button');
        button.append(icon);
        button.style.marginLeft = '10px';
        button.style.borderRadius = '10px';
        button.style.fontSize = '20px';
        button.style.color = 'white';
        button.style.backgroundColor = 'blue';
        textareaContainer.appendChild(button);

        const wordCount = document.createElement('p');
        wordCount.setAttribute('id', 'wordCount');
        contenedor.appendChild(wordCount);  // Agregar wordCount al contenedor principal




       
        const maxWords = 140;

        // Función para contar palabras
        const countWords = (text) => {
           
            const wordCount = text.length;
            return wordCount;
        };

        // Actualizar el contador de palabras al escribir en el textarea
        text.addEventListener('input', () => {
            const count = countWords(text.value);
            wordCount.textContent = ` (${count} ${count === 1 ? '/140)' : '/140)'}`;

            // Verificar si se ha excedido el límite de palabras
            if (count > maxWords) {
                // Truncar el texto ingresado
                const truncatedText = text.value
                    .split(/\s+/)
                    .slice(0, maxWords)
                    .join(' ');
                text.value = truncatedText;
                wordCount.textContent = `${maxWords} caracteres (límite alcanzado)`;
                button.disabled = true;
            }else {
                button.disabled = false;
            }
        });

        //Funcion obtener mensajes
        const getMessages= async()=> {
            const response = await fetch('https://chat.tiburoncin.lat/messages');
            const messages = await response.json();
            
            const isScrolledToBottom = ulContenedor.scrollHeight - ulContenedor.clientHeight <= ulContenedor.scrollTop + 1;
            ul.innerHTML = '';
            messages.forEach((element) => {
                const li = document.createElement('li');
                li.style.display = 'table';
                li.style.verticalAlign = 'right';
                //les damos estilo a los li
                
                if (element.message.startsWith('https://') && (element.message.includes('png') || element.message.includes('jpg')|| element.message.includes('gif') || element.message.includes('jpeg')) ) {
                        li.append(`${element.username}  : `);
                        li.appendChild(document.createElement('br'));
                        const img = document.createElement('img');
                        img.src = element.message;
                        img.style.maxWidth = '170px'; // Ajustar el ancho máximo de la imagen

                        img.onerror = function() {
                            img.src = 'https://ruta/a/imagen_de_error.jpg'; // URL de la imagen de error
                            img.alt = 'Imagen no disponible'; // Texto alternativo para la imagen de error
                        };
                        li.appendChild(img);
                }else{
                    li.append(`${element.username}  :  ${element.message}\n`);
                }
                li.style.listStyleType = 'none';
                
                li.style.backgroundColor = '#e0f1fd';
                li.style.marginBottom = '8px';
                li.style.height = 'fit-content';
                li.style.borderRadius = '10%'
                li.style.padding = '10px';
                
                ul.insertBefore(li, ul.firstChild);
            });
            if (isScrolledToBottom) {
                ulContenedor.scrollTop = ulContenedor.scrollHeight;
            }
        }

        //Funcion enviar mensajes
        const setMessages = async()=>{
            const body = {
                username: 'elMatius',
                message: text.value
            }
            const response = await fetch('https://chat.tiburoncin.lat/messages',
            {
                method: 'POST',
                body: JSON.stringify(body)
            })
            text.value = ''; // Limpiar el textarea después de enviar el mensaje
        }
       
        //enviar si se toca el boton
        button.addEventListener('click',setMessages);
        //enviar si se toca el enter
        // Función para enviar mensajes cuando se presiona "Enter"
        const enviarConEnter = (event) => {
            if (event.keyCode === 13) { // 13 es el código de la tecla "Enter"
                event.preventDefault(); // Evita que se inserte un salto de línea en el textarea
                if (countWords(text.value) <= maxWords) {
                    setMessages(); // Llama a la función setMessages para enviar el mensaje
                }
            }
        };
        

        // Agregar el event listener al textarea
        text.addEventListener('keydown', enviarConEnter);

        // Actualizar los mensajes cada 1 segundos (1000 milisegundos)
        setInterval(getMessages, 1000);
        
        // Cargar los mensajes al cargar la página
        getMessages();
    </script>
  </body>
</html>
