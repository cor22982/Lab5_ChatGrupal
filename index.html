<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <script type="application/javascript">

        //Vamos a colocar las constantes

        const contenedor = document.createElement('div');

        contenedor.setAttribute('class', 'contenedor');
        contenedor.style.width = '750px'; // Ajusta el ancho según tus necesidades
        contenedor.style.height = '400px'; // Ajusta la altura según tus necesidades
        contenedor.style.backgroundColor = '#ffffff'; // Solo para visualización
        contenedor.style.position = 'fixed';
        contenedor.style.top = '50%';
        contenedor.style.left = '50%';
        contenedor.style.transform = 'translate(-50%, -50%)';
        contenedor.style.borderColor = 'black'
        contenedor.style.borderRadius = '1.5%'
        contenedor.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.5)';
        
      // Agrega el contenedor al body del documento
        document.body.appendChild(contenedor);

        //Creamos los elementos
        const ulContenedor = document.createElement('div'); // Contenedor para ul
        ulContenedor.style.overflowY = 'auto'; // Agregar scroll vertical si es necesario
        ulContenedor.style.maxHeight = '400px'; // Establecer una altura máxima para el contenedor
        contenedor.appendChild(ulContenedor); // Agregar contenedor de ul al contenedor principal
        


        const ul = document.createElement('ul');
        ulContenedor.appendChild(ul); // Agregar ul al contenedor de ul


        //elementos de enviar mensajes
        const text = document.createElement('textarea'); //el text area
        text.setAttribute('id', 'text');
        text.setAttribute('rows', '2');
        text.setAttribute('cols', '85');
        contenedor.appendChild(text); // Agregar text al contenedor principal

        const wordCount = document.createElement('p');
        wordCount.setAttribute('id', 'wordCount');
        contenedor.appendChild(wordCount); // Agregar wordCount al contenedor principal


        const button = document.createElement('button');
        button.append('ENVIAR');
        contenedor.appendChild(button); // Agregar button al contenedor principal

        const lightnight = document.createElement('button');
        lightnight.append('ChangeMod');
        contenedor.appendChild(lightnight); // Agregar lightnight al contenedor principal

        const maxWords = 140;

        // Función para contar palabras
        const countWords = (text) => {
           
            const wordCount = text.length;
            return wordCount;
        };

        // Actualizar el contador de palabras al escribir en el textarea
        text.addEventListener('input', () => {
            const count = countWords(text.value);
            wordCount.textContent = `${count} ${count === 1 ? 'caracter' : 'caracteres'}`;

            // Verificar si se ha excedido el límite de palabras
            if (count > maxWords) {
                // Truncar el texto ingresado
                const truncatedText = text.value
                    .split(/\s+/)
                    .slice(0, maxWords)
                    .join(' ');
                text.value = truncatedText;
                wordCount.textContent = `${maxWords} caracteres (límite alcanzado)`;
                button.disabled = true;
            }else {
                button.disabled = false;
            }
        });

        //Funcion obtener mensajes
        const getMessages= async()=> {
            const response = await fetch('https://chat.tiburoncin.lat/messages');
            const messages = await response.json();
            
            const isScrolledToBottom = ulContenedor.scrollHeight - ulContenedor.clientHeight <= ulContenedor.scrollTop + 1;
            ul.innerHTML = '';
            messages.forEach((element) => {
                const li = document.createElement('li');
                //les damos estilo a los li
                
                if (element.message.startsWith('https://') && (element.message.includes('png') || element.message.includes('jpg')) ) {

                        console.log(element.message);
                        console.log(element.message.endsWith('png'));
                        const img = document.createElement('img');
                        img.src = element.message;
                        img.style.maxWidth = '170px'; // Ajustar el ancho máximo de la imagen
                        li.appendChild(img);
                }else{
                    li.append(`${element.username}: ${element.message}`);
                }
                li.style.listStyleType = 'none';
                li.style.display = 'table';
                li.style.backgroundColor = '#e0f1fd';
                li.style.marginBottom = '8px';
                li.style.height = 'fit-content';
                li.style.borderRadius = '10%'
                li.style.padding = '10px';
            
                ul.insertBefore(li, ul.firstChild);
            });
            if (isScrolledToBottom) {
                ulContenedor.scrollTop = ulContenedor.scrollHeight;
            }
        }

        //Funcion enviar mensajes
        const setMessages = async()=>{
            const body = {
                username: 'elMatius',
                message: text.value
            }
            const response = await fetch('https://chat.tiburoncin.lat/messages',
            {
                method: 'POST',
                body: JSON.stringify(body)
            })
            text.value = ''; // Limpiar el textarea después de enviar el mensaje
        }
       
        //enviar si se toca el boton
        button.addEventListener('click',setMessages);
        //enviar si se toca el enter
        // Función para enviar mensajes cuando se presiona "Enter"
        const enviarConEnter = (event) => {
            if (event.keyCode === 13) { // 13 es el código de la tecla "Enter"
                event.preventDefault(); // Evita que se inserte un salto de línea en el textarea
                if (countWords(text.value) <= maxWords) {
                    setMessages(); // Llama a la función setMessages para enviar el mensaje
                }
            }
        };
        

        // Agregar el event listener al textarea
        text.addEventListener('keydown', enviarConEnter);

        // Actualizar los mensajes cada 1 segundos (1000 milisegundos)
        setInterval(getMessages, 1000);
        
        // Cargar los mensajes al cargar la página
        getMessages();
    </script>
  </body>
</html>
